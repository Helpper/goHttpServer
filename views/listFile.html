{{define "listFile"}}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{.ListFileTitle}}</title>
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <style type="text/css">
    </style>
    <script type="text/javascript">
    //上传进度
    function uploadProgress(evt) {
    	  if (evt.lengthComputable) {
    	    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
    	    document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
    	  }
    	  else {
    	    document.getElementById('progressNumber').innerHTML = 'unable to compute';
    	  }
    }
    
    function cleanProgress(){
    	document.getElementById('progressNumber').innerHTML = '';
    }
    
        //监听选择文件信息
    function fileSelected() {
    	//HTML5文件API操作
    	  var file = document.getElementById('userfile').files[0];
    	  if (file) {
    	    var fileSize = 0;
    	    if (file.size > 1024 * 1024)
    	      fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
    	    else
    	      fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

    	    document.getElementById('userfile').innerHTML = 'Name: ' + file.name;
    	    document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
    	    document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
    	    cleanProgress();
    	  }
    }
    
    </script>
</head>

<body role="document" youdao="bind">
<div class="container theme-showcase" role="main">
	<br /><br />
    <form id="uploadForm" name="uploadForm" enctype="multipart/form-data" action="/upload" method="POST">
        <input type="file" id="userfile" name="userfile" onchange="fileSelected()" multiple/> <br/>
    </form>
    <button type="button" class="btn btn-primary" onclick="UpLoadFile()">上传文件</button>
    <div id="progressNumber"></div>
    <div id="userfile"></div>
    <div id="fileSize"></div>
    <div id="fileType"></div>
</div>

<script src="static/js/jquery-2.1.3.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>
<script>
    $(function () {
        ListFile();
    });
    function DelFile() {
        var filename = new Array();
        $(".mycheckbox").each(function () {
            if ($(this).is(':checked')) {
                //   console.log($(this).val())
                filename.push($(this).parent().prev().prev().text());
            }
        });
        if (filename.length < 1) return;   //没有选择时退出
        var o = new Object();
        o.filename = filename;
        $.ajax({
            type: 'DELETE',
            url: "/file",
            data: JSON.stringify(o),
            contentType: 'application/json',
            success: function (msg) {
                // console.log(msg);
                ListFile();
            },
            error: function () {
                alert("删除文件出错");
            }
        });
    }
    function ListFile() {
        $(".myrow").remove();
        $.ajax({
            type: "GET",//使用get方法访问后台
            dataType: "json",//返回json格式的数据
            url: "/file",//要访问的后台地址
            cache: false,
            success: function (msg) {//msg为返回的数据，在这里做数据绑定
                // console.log(msg);
                $("#mytemplate").show();
                $.each(msg, function (i, n) {
                    var row = $("#mytemplate").clone();
                    row.addClass("myrow");
                    row.find("#NO").text(i);
                    row.find("#Name").html("<a href='/files/" + n.name + "'>" + n.name + "</a>");
                    row.find("#Size").text(n.size);
                    row.find("#Operation").html("<input class='mycheckbox'type='checkbox' value='" + i + "'>");
                    row.appendTo("#datas");//添加到模板的容器中
                });
                $("#mytemplate").hide();   //隐藏模板
            },
            error: function () {
                alert("连接服务器错误");
            }
        });
    }
    function UpLoadFile() {
        // FormData 对象
        var form = new FormData(document.forms.namedItem("uploadForm"));
        //form.append("name", "dd");                        // 可以增加表单数据
        // XMLHttpRequest 对象
        var xhr = new XMLHttpRequest();
        xhr.open("post", "/file", true);
        xhr.upload.addEventListener("progress", uploadProgress, false);
        // xhr.upload 这是html5新增的api,储存了上传过程中的信息
        xhr.upload.onprogress = function (ev) {
            var percent = 0;
            if (ev.lengthComputable) {
                percent = 100 * ev.loaded / ev.total;
                $("#myprogress").width(percent + "%");
            }
        };
        xhr.onload = function (oEvent) {
            if (xhr.status == 200) {
                ListFile();
            }
        }
        xhr.send(form);
    }
</script>
</body>

</html>
{{end}}